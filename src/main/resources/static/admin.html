<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <title>Panel Admina</title>
    <style>
        th:nth-child(3) {
            width: 130px;
            white-space: nowrap;
        }
        #availability-filter {
            display: inline-block;
            width: 130px;
            text-align: center;
            white-space: nowrap;
        }


        h2 {
            margin-top: 30px;
            cursor: pointer;
            background-color: #f0f0f0;
            padding: 10px;
            border: 1px solid #ccc;
        }
        .section-content {
            display: none;
            margin-top: 10px;
        }
    body {
            font-family: Arial, sans-serif;
            margin: 40px;
        }
        h2 {
            margin-top: 30px;
        }
        form {
            margin-bottom: 30px;
            padding: 10px;
            border: 1px solid #ccc;
            width: 300px;
        }
        input, select, button {
            display: block;
            margin-top: 10px;
            padding: 5px;
            width: 100%;
        }
        table {
            border-collapse: collapse;
            width: 100%;
            margin-top: 15px;
        }
        th, td {
            border: 1px solid #ccc;
            padding: 8px;
        }
        th {
            background-color: #eee;
        }

    </style>
</head>
<body>
<h1>Panel Administratora</h1>

<h2 onclick="toggleSection('user-section')">‚ûï Dodaj u≈ºytkownika</h2>
<div id="user-section" class="section-content">
    <form id="user-form">
        <input name="name" placeholder="Imiƒô" required>
        <input name="surname" placeholder="Nazwisko" required>
        <input name="email" placeholder="Email" type="email" required>
        <input name="password" placeholder="Has≈Ço" type="password" required>
        <button type="submit">Dodaj u≈ºytkownika</button>
    </form>
</div>

<h2 onclick="toggleSection('book-section')">üìö Dodaj ksiƒÖ≈ºkƒô</h2>
<div id="book-section" class="section-content">
    <form id="book-form">
        <input name="title" placeholder="Tytu≈Ç" required>
        <input name="author" placeholder="Autor" required>
        <button type="submit">Dodaj ksiƒÖ≈ºkƒô</button>
    </form>
</div>

<h2 onclick="toggleSection('user-search-section')">üîç Wyszukaj u≈ºytkownika</h2>
<div id="user-search-section" class="section-content">
    <form id="user-redirect">
        <select id="user-select-redirect" required>
            <option value="">Wybierz u≈ºytkownika</option>
        </select>
        <button type="submit">Przejd≈∫ do profilu</button>
    </form>
</div>

<h2 onclick="toggleSection('books-list-section')">üìñ Lista wszystkich ksiƒÖ≈ºek</h2>
<div id="books-list-section" class="section-content">
    <table id="books-table">
        <thead>
        <tr>
            <th>
                <input type="text" id="filter-title" placeholder="Filtruj tytu≈Ç..." style="width: 90%; margin-top: 5px;">
                <button class="sort-btn" data-field="title" aria-label="Sortuj po tytule" style="background:none; border:none; cursor:pointer;">‚ñ≤</button><br>
            </th>
            <th>
                <input type="text" id="filter-author" placeholder="Filtruj autora..." style="width: 90%; margin-top: 5px;">
                <button class="sort-btn" data-field="author" aria-label="Sortuj po autorze" style="background:none; border:none; cursor:pointer;">‚ñ≤</button><br>
            </th>
            <th>
                <button id="availability-filter" aria-label="Filtruj po dostƒôpno≈õci" style="background:none; border:none; cursor:pointer; font-weight:bold;">
                    Wszystkie
                </button>
            </th>

        </tr>
        </thead>


        <tbody>
        <tr><td colspan="3">≈Åadowanie ksiƒÖ≈ºek...</td></tr>
        </tbody>
    </table>
</div>

<script>
    let allBooks = [];
    let currentSortField = 'title';
    let availabilityFilter = 'all';


    (function verifyAdminAccess() {
        const token = localStorage.getItem('jwtToken');

        if (!token) {
            alert('Brak autoryzacji. Zaloguj siƒô jako administrator.');
            window.location.href = '/index.html';
            return;
        }

        try {
            const payload = JSON.parse(atob(token.split('.')[1]));

            if (payload.role !== 'admin') {
                alert('Brak dostƒôpu. Musisz byƒá administratorem.');
                window.location.href = '/index.html';
            }
        } catch (e) {
            alert('Nieprawid≈Çowy token. Zaloguj siƒô ponownie.');
            localStorage.removeItem('jwtToken');
            window.location.href = '/index.html';
        }
    })();

    window.onload = () => {
        // ≈Åadowanie u≈ºytkownik√≥w do selecta
        fetch('/users')
            .then(res => res.json())
            .then(users => {
                const userRedirectSelect = document.getElementById('user-select-redirect');
                users.forEach(user => {
                    const option = document.createElement('option');
                    option.value = user.id;
                    option.textContent = `${user.email} ‚Äì ${user.name}`;
                    userRedirectSelect.appendChild(option);
                });
            });

        // ≈Åadowanie ksiƒÖ≈ºek domy≈õlnie po tytule
        loadBooks('title');
    };

    // Funkcja ≈ÇadujƒÖca ksiƒÖ≈ºki z backendu
    function loadBooks(sortBy = 'title') {
        fetch(`/books?sortBy=${sortBy}`)
            .then(res => res.json())
            .then(books => {
                allBooks = books;
                currentSortField = sortBy;
                renderBooksTable();
            });
    }

    document.getElementById('filter-title').addEventListener('input', renderBooksTable);
    document.getElementById('filter-author').addEventListener('input', renderBooksTable);

    // Renderowanie tabeli ksiƒÖ≈ºek
    function renderBooksTable() {
        const tbody = document.querySelector('#books-table tbody');
        tbody.innerHTML = '';

        const filterTitle = document.getElementById('filter-title').value.toLowerCase();
        const filterAuthor = document.getElementById('filter-author').value.toLowerCase();

        // Filtrowanie lokalne na ju≈º pobranych danych
        const filteredBooks = allBooks.filter(book =>
            book.title.toLowerCase().includes(filterTitle) &&
            book.author.toLowerCase().includes(filterAuthor) &&
            (availabilityFilter === 'all' ||
                (availabilityFilter === 'available' && book.available) ||
                (availabilityFilter === 'borrowed' && !book.available))
        );


        if (filteredBooks.length === 0) {
            tbody.innerHTML = '<tr><td colspan="3">Brak wynik√≥w.</td></tr>';
            return;
        }


        filteredBooks.forEach(book => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
            <td>${book.title}</td>
            <td>${book.author}</td>
            <td>${book.available ? '‚úÖ' : '‚ùå'}</td>
        `;
            tbody.appendChild(tr);
        });

        updateSortButtons();
    }


    // Aktualizacja wyglƒÖdu strza≈Çek sortowania
    function updateSortButtons() {
        document.querySelectorAll('.sort-btn').forEach(button => {
            const field = button.dataset.field;
            if (field === currentSortField) {
                button.style.color = 'black';  // aktywna strza≈Çka
                button.textContent = '‚ñ≤';
            } else {
                button.style.color = '#ccc';   // nieaktywna strza≈Çka szara
                button.textContent = '‚ñ≤';
            }
        });
    }

    // Obs≈Çuga klikniƒôƒá w sortowanie
    document.querySelectorAll('.sort-btn').forEach(button => {
        button.addEventListener('click', () => {
            const field = button.dataset.field;
            if (field !== currentSortField) {
                loadBooks(field);
            }
            // je≈õli klikniƒôto na aktualne sortowanie, nic siƒô nie zmienia, bo backend sortuje tylko ASC
        });
    });

    // Dodawanie u≈ºytkownika
    document.getElementById('user-form').addEventListener('submit', function(e) {
        e.preventDefault();
        const formData = new FormData(this);
        const user = {
            name: formData.get('name'),
            surname: formData.get('surname'),
            email: formData.get('email'),
            password: formData.get('password')
        };
        fetch('/add-user', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(user)
        }).then(res => {
            alert(res.ok ? 'U≈ºytkownik dodany!' : 'B≈ÇƒÖd przy dodawaniu u≈ºytkownika.');
            if (res.ok) {
                this.reset();
            }
        });
    });

    // Dodawanie ksiƒÖ≈ºki
    document.getElementById('book-form').addEventListener('submit', function(e) {
        e.preventDefault();
        const formData = new FormData(this);
        const book = {
            title: formData.get('title'),
            author: formData.get('author'),
            available: true
        };
        fetch('/book', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(book)
        }).then(res => {
            alert(res.ok ? 'KsiƒÖ≈ºka dodana!' : 'B≈ÇƒÖd przy dodawaniu ksiƒÖ≈ºki.');
            if (res.ok) {
                this.reset();
                loadBooks(currentSortField);  // od≈õwie≈º listƒô po dodaniu ksiƒÖ≈ºki
            }
        });
    });

    // Przej≈õcie do profilu u≈ºytkownika
    document.getElementById('user-redirect').addEventListener('submit', function(e) {
        e.preventDefault();
        const userId = document.getElementById('user-select-redirect').value;
        if (userId) {
            window.location.href = `user.html?id=${userId}`;
        }
    });

    // Funkcja do pokazywania/ukrywania sekcji
    function toggleSection(id) {
        const section = document.getElementById(id);
        section.style.display = (section.style.display === 'none' || section.style.display === '') ? 'block' : 'none';
    }
    document.getElementById('availability-filter').addEventListener('click', () => {
        if (availabilityFilter === 'all') {
            availabilityFilter = 'available';
        } else if (availabilityFilter === 'available') {
            availabilityFilter = 'borrowed';
        } else {
            availabilityFilter = 'all';
        }
        updateAvailabilityFilterText();
        renderBooksTable();
    });

    function updateAvailabilityFilterText() {
        const btn = document.getElementById('availability-filter');
        if (availabilityFilter === 'all') {
            btn.textContent = 'Wszystkie';
        } else if (availabilityFilter === 'available') {
            btn.textContent = 'Tylko dostƒôpne';
        } else if (availabilityFilter === 'borrowed') {
            btn.textContent = 'Tylko wypo≈ºyczone';
        }
        btn.style.maxWidth = '130px'; // wymusz minimalnƒÖ szeroko≈õƒá
    }

</script>

</body>
</html>
