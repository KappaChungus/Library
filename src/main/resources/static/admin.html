<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <title>Panel Admina</title>
    <link rel="stylesheet" href="/admin.css"/>
    <link rel="stylesheet" href="/dark-mode-toggle.css" />
</head>
<body>

<h1>Panel Administratora</h1>

<!-- Przycisk trybu ciemnego/ jasnego -->
<button id="dark-mode-toggle">ğŸŒ™</button>

<h2 onclick="toggleSection('user-section')">â• Dodaj uÅ¼ytkownika</h2>
<div id="user-section" class="section-content">
    <form id="user-form">
        <input name="name" placeholder="ImiÄ™" required>
        <input name="surname" placeholder="Nazwisko" required>
        <input name="email" placeholder="Email" type="email" required>
        <input name="password" placeholder="HasÅ‚o" type="password" required>
        <button type="submit">Dodaj uÅ¼ytkownika</button>
    </form>
</div>

<h2 onclick="toggleSection('book-section')">ğŸ“š Dodaj ksiÄ…Å¼kÄ™</h2>
<div id="book-section" class="section-content">
    <form id="book-form">
        <input name="title" placeholder="TytuÅ‚" required>
        <input name="author" placeholder="Autor" required>
        <button type="submit">Dodaj ksiÄ…Å¼kÄ™</button>
    </form>
</div>

<h2 onclick="toggleSection('user-search-section')">ğŸ” Wyszukaj uÅ¼ytkownika</h2>
<div id="user-search-section" class="section-content">
    <form id="user-redirect">
        <select id="user-select-redirect" required>
            <option value="">Wybierz uÅ¼ytkownika</option>
        </select>
        <button type="submit">PrzejdÅº do profilu</button>
    </form>
</div>

<h2 onclick="toggleSection('books-list-section')">ğŸ“– Lista wszystkich ksiÄ…Å¼ek</h2>
<div id="books-list-section" class="section-content">
    <table id="books-table">
        <thead>
        <tr>
            <th>
                <input type="text" id="filter-title" placeholder="Filtruj tytuÅ‚..." style="width: 90%; margin-top: 5px;">
                <button class="sort-btn" data-field="title" aria-label="Sortuj po tytule" style="background:none; border:none; cursor:pointer;">â–²</button><br>
            </th>
            <th>
                <input type="text" id="filter-author" placeholder="Filtruj autora..." style="width: 90%; margin-top: 5px;">
                <button class="sort-btn" data-field="author" aria-label="Sortuj po autorze" style="background:none; border:none; cursor:pointer;">â–²</button><br>
            </th>
            <th>
                <button id="availability-filter" aria-label="Filtruj po dostÄ™pnoÅ›ci" style="background:none; border:none; cursor:pointer; font-weight:bold;">
                    Wszystkie
                </button>
            </th>
        </tr>
        </thead>
        <tbody>
        <tr><td colspan="3">Åadowanie ksiÄ…Å¼ek...</td></tr>
        </tbody>
    </table>
</div>

<script>
    let allBooks = [];
    let currentSortField = 'title';
    let availabilityFilter = 'all';

    (function verifyAdminAccess() {
        const token = localStorage.getItem('jwtToken');

        if (!token) {
            alert('Brak autoryzacji. Zaloguj siÄ™ jako administrator.');
            window.location.href = '/index.html';
            return;
        }

        try {
            const payload = JSON.parse(atob(token.split('.')[1]));

            if (payload.role !== 'admin') {
                alert('Brak dostÄ™pu. Musisz byÄ‡ administratorem.');
                window.location.href = '/index.html';
            }
        } catch (e) {
            alert('NieprawidÅ‚owy token. Zaloguj siÄ™ ponownie.');
            localStorage.removeItem('jwtToken');
            window.location.href = '/index.html';
        }
    })();

    window.onload = () => {
        // PrzywrÃ³Ä‡ tryb ciemny jeÅ›li ustawiony
        const darkModeToggle = document.getElementById('dark-mode-toggle');
        if (localStorage.getItem('darkMode') === 'enabled') {
            document.body.classList.add('dark-mode');
            darkModeToggle.textContent = 'â˜€ï¸';
        } else {
            darkModeToggle.textContent = 'ğŸŒ™';
        }

        // Åadowanie uÅ¼ytkownikÃ³w do selecta
        fetch('/data/users')
            .then(res => res.json())
            .then(users => {
                const userRedirectSelect = document.getElementById('user-select-redirect');
                users.forEach(user => {
                    const option = document.createElement('option');
                    option.value = user.id;
                    option.textContent = `${user.email} â€“ ${user.name}`;
                    userRedirectSelect.appendChild(option);
                });
            });

        // Åadowanie ksiÄ…Å¼ek domyÅ›lnie po tytule
        loadBooks('title');
    };

    document.getElementById('dark-mode-toggle').addEventListener('click', () => {
        const btn = document.getElementById('dark-mode-toggle');
        if (document.body.classList.contains('dark-mode')) {
            document.body.classList.remove('dark-mode');
            btn.textContent = 'ğŸŒ™';
            localStorage.setItem('darkMode', 'disabled');
        } else {
            document.body.classList.add('dark-mode');
            btn.textContent = 'â˜€ï¸';
            localStorage.setItem('darkMode', 'enabled');
        }
    });

    // Funkcja Å‚adujÄ…ca ksiÄ…Å¼ki z backendu
    function loadBooks(sortBy = 'title') {
        fetch(`/data/books?sortBy=${sortBy}`)
            .then(res => res.json())
            .then(books => {
                allBooks = books;
                currentSortField = sortBy;
                renderBooksTable();
            });
    }

    document.getElementById('filter-title').addEventListener('input', renderBooksTable);
    document.getElementById('filter-author').addEventListener('input', renderBooksTable);

    // Renderowanie tabeli ksiÄ…Å¼ek
    function renderBooksTable() {
        const tbody = document.querySelector('#books-table tbody');
        tbody.innerHTML = '';

        const filterTitle = document.getElementById('filter-title').value.toLowerCase();
        const filterAuthor = document.getElementById('filter-author').value.toLowerCase();

        // Filtrowanie lokalne na juÅ¼ pobranych danych
        const filteredBooks = allBooks.filter(book =>
            book.title.toLowerCase().includes(filterTitle) &&
            book.author.toLowerCase().includes(filterAuthor) &&
            (availabilityFilter === 'all' ||
                (availabilityFilter === 'available' && book.available) ||
                (availabilityFilter === 'borrowed' && !book.available))
        );


        if (filteredBooks.length === 0) {
            tbody.innerHTML = '<tr><td colspan="3">Brak wynikÃ³w.</td></tr>';
            return;
        }


        filteredBooks.forEach(book => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
            <td>${book.title}</td>
            <td>${book.author}</td>
            <td>${book.available ? 'âœ…' : 'âŒ'}</td>
        `;
            tbody.appendChild(tr);
        });

        updateSortButtons();
    }


    // Aktualizacja wyglÄ…du strzaÅ‚ek sortowania
    function updateSortButtons() {
        document.querySelectorAll('.sort-btn').forEach(button => {
            const field = button.dataset.field;
            if (field === currentSortField) {
                button.style.color = 'black';  // aktywna strzaÅ‚ka
                button.textContent = 'â–²';
            } else {
                button.style.color = '#ccc';   // nieaktywna strzaÅ‚ka szara
                button.textContent = 'â–²';
            }
        });
    }

    // ObsÅ‚uga klikniÄ™Ä‡ w sortowanie
    document.querySelectorAll('.sort-btn').forEach(button => {
        button.addEventListener('click', () => {
            const field = button.dataset.field;
            if (field !== currentSortField) {
                loadBooks(field);
            }
            // jeÅ›li klikniÄ™to na aktualne sortowanie, nic siÄ™ nie zmienia, bo backend sortuje tylko ASC
        });
    });

    // Dodawanie uÅ¼ytkownika
    document.getElementById('user-form').addEventListener('submit', function(e) {
        e.preventDefault();
        const formData = new FormData(this);
        const user = {
            name: formData.get('name'),
            surname: formData.get('surname'),
            email: formData.get('email'),
            password: formData.get('password')
        };
        fetch('/data/add-user', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(user)
        }).then(res => {
            alert(res.ok ? 'UÅ¼ytkownik dodany!' : 'BÅ‚Ä…d przy dodawaniu uÅ¼ytkownika.');
            if (res.ok) {
                this.reset();
            }
        });
    });

    // Dodawanie ksiÄ…Å¼ki
    document.getElementById('book-form').addEventListener('submit', function(e) {
        e.preventDefault();
        const formData = new FormData(this);
        const book = {
            title: formData.get('title'),
            author: formData.get('author'),
            available: true
        };
        fetch('/data/book', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(book)
        }).then(res => {
            alert(res.ok ? 'KsiÄ…Å¼ka dodana!' : 'BÅ‚Ä…d przy dodawaniu ksiÄ…Å¼ki.');
            if (res.ok) {
                this.reset();
                loadBooks(currentSortField);  // odÅ›wieÅ¼ listÄ™ po dodaniu ksiÄ…Å¼ki
            }
        });
    });

    // PrzejÅ›cie do profilu uÅ¼ytkownika
    document.getElementById('user-redirect').addEventListener('submit', function(e) {
        e.preventDefault();
        const userId = document.getElementById('user-select-redirect').value;
        if (userId) {
            window.location.href = `user.html?id=${userId}`;
        }
    });

    // Funkcja do pokazywania/ukrywania sekcji
    function toggleSection(id) {
        const section = document.getElementById(id);
        section.style.display = (section.style.display === 'none' || section.style.display === '') ? 'block' : 'none';
    }
    document.getElementById('availability-filter').addEventListener('click', () => {
        if (availabilityFilter === 'all') {
            availabilityFilter = 'available';
        } else if (availabilityFilter === 'available') {
            availabilityFilter = 'borrowed';
        } else {
            availabilityFilter = 'all';
        }
        updateAvailabilityFilterText();
        renderBooksTable();
    });

    function updateAvailabilityFilterText() {
        const btn = document.getElementById('availability-filter');
        if (availabilityFilter === 'all') {
            btn.textContent = 'Wszystkie';
        } else if (availabilityFilter === 'available') {
            btn.textContent = 'Tylko dostÄ™pne';
        } else if (availabilityFilter === 'borrowed') {
            btn.textContent = 'Tylko wypoÅ¼yczone';
        }
        btn.style.maxWidth = '130px'; // wymusz minimalnÄ… szerokoÅ›Ä‡
    }

</script>

</body>
</html>
